<div class="flex min-h-screen bg-gray-50">
  <app-sidebar></app-sidebar>

  <div class="ml-64 flex-1">
    <div class="p-8">
      <!-- Header -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Audit Trail</h1>
        <p class="text-gray-600 mt-1">History of rule and configuration changes</p>
      </div>

      <!-- Loading State -->
      <div *ngIf="loading" class="flex justify-center items-center py-20">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
      </div>

      <!-- Error State -->
      <div *ngIf="error && !loading" class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
        <div class="flex items-center">
          <svg class="w-5 h-5 text-red-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <p class="text-sm font-medium text-red-800">{{ error }}</p>
        </div>
      </div>

      <div *ngIf="!loading && !error" class="space-y-4">

        <!-- Rule History Accordion -->
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
          <button
            (click)="toggleSection('rules')"
            class="w-full px-6 py-4 bg-gray-50 border-b border-gray-200 flex items-center justify-between hover:bg-gray-100 transition-colors"
            data-testid="accordion-rules"
          >
            <div class="text-left">
              <h2 class="text-lg font-semibold text-gray-900">Rule History</h2>
              <p class="text-sm text-gray-500 mt-1">{{ ruleTotal }} total entries</p>
            </div>
            <svg
              class="w-5 h-5 text-gray-500 transition-transform"
              [class.rotate-180]="sections['rules']"
              fill="none" stroke="currentColor" viewBox="0 0 24 24"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>

          <div *ngIf="sections['rules']">
            <div *ngIf="ruleHistory.length === 0" class="p-6 text-center text-gray-500">
              No rule history entries found.
            </div>

            <div *ngIf="ruleHistory.length > 0" class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Version</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Rule ID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Changed By</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Changed</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <tr *ngFor="let entry of ruleHistory" class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                      <a [routerLink]="['/rules', entry.r_id, 'revisions', entry.version]" class="text-blue-600 hover:text-blue-800 hover:underline">{{ entry.version }}</a>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-mono">
                      <a [routerLink]="['/rules', entry.r_id]" class="text-blue-600 hover:text-blue-800 hover:underline">{{ entry.rid }}</a>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-600" [title]="entry.description">{{ truncateDescription(entry.description) }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ entry.changed_by || '—' }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ formatDate(entry.changed) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Configuration History Accordion -->
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
          <button
            (click)="toggleSection('config')"
            class="w-full px-6 py-4 bg-gray-50 border-b border-gray-200 flex items-center justify-between hover:bg-gray-100 transition-colors"
            data-testid="accordion-config"
          >
            <div class="text-left">
              <h2 class="text-lg font-semibold text-gray-900">Configuration History</h2>
              <p class="text-sm text-gray-500 mt-1">{{ configTotal }} total entries</p>
            </div>
            <svg
              class="w-5 h-5 text-gray-500 transition-transform"
              [class.rotate-180]="sections['config']"
              fill="none" stroke="currentColor" viewBox="0 0 24 24"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>

          <div *ngIf="sections['config']">
            <div *ngIf="configHistory.length === 0" class="p-6 text-center text-gray-500">
              No configuration history entries found.
            </div>

            <div *ngIf="configHistory.length > 0" class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Version</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Label</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Changed By</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Changed</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <tr *ngFor="let entry of configHistory" class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ entry.version }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ entry.label }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ entry.changed_by || '—' }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ formatDate(entry.changed) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- User List History Accordion -->
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
          <button
            (click)="toggleSection('userLists')"
            class="w-full px-6 py-4 bg-gray-50 border-b border-gray-200 flex items-center justify-between hover:bg-gray-100 transition-colors"
            data-testid="accordion-user-lists"
          >
            <div class="text-left">
              <h2 class="text-lg font-semibold text-gray-900">User List History</h2>
              <p class="text-sm text-gray-500 mt-1">{{ userListTotal }} total entries</p>
            </div>
            <svg
              class="w-5 h-5 text-gray-500 transition-transform"
              [class.rotate-180]="sections['userLists']"
              fill="none" stroke="currentColor" viewBox="0 0 24 24"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>

          <div *ngIf="sections['userLists']">
            <div *ngIf="userListHistory.length === 0" class="p-6 text-center text-gray-500">
              No user list history entries found.
            </div>

            <div *ngIf="userListHistory.length > 0" class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">List Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Changed By</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Changed</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <tr *ngFor="let entry of userListHistory" class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ entry.list_name }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                        [ngClass]="{
                          'bg-green-100 text-green-800': entry.action === 'created' || entry.action === 'entry_added' || entry.action === 'entries_bulk_added',
                          'bg-red-100 text-red-800': entry.action === 'deleted' || entry.action === 'entry_removed',
                          'bg-blue-100 text-blue-800': entry.action === 'renamed'
                        }"
                      >{{ formatAction(entry.action) }}</span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-600">{{ entry.details || '—' }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ entry.changed_by || '—' }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ formatDate(entry.changed) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Outcome History Accordion -->
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
          <button
            (click)="toggleSection('outcomes')"
            class="w-full px-6 py-4 bg-gray-50 border-b border-gray-200 flex items-center justify-between hover:bg-gray-100 transition-colors"
            data-testid="accordion-outcomes"
          >
            <div class="text-left">
              <h2 class="text-lg font-semibold text-gray-900">Outcome History</h2>
              <p class="text-sm text-gray-500 mt-1">{{ outcomeTotal }} total entries</p>
            </div>
            <svg
              class="w-5 h-5 text-gray-500 transition-transform"
              [class.rotate-180]="sections['outcomes']"
              fill="none" stroke="currentColor" viewBox="0 0 24 24"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>

          <div *ngIf="sections['outcomes']">
            <div *ngIf="outcomeHistory.length === 0" class="p-6 text-center text-gray-500">
              No outcome history entries found.
            </div>

            <div *ngIf="outcomeHistory.length > 0" class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Outcome</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Changed By</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Changed</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <tr *ngFor="let entry of outcomeHistory" class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ entry.outcome_name }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                        [ngClass]="{
                          'bg-green-100 text-green-800': entry.action === 'created',
                          'bg-red-100 text-red-800': entry.action === 'deleted'
                        }"
                      >{{ formatAction(entry.action) }}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ entry.changed_by || '—' }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ formatDate(entry.changed) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Label History Accordion -->
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
          <button
            (click)="toggleSection('labels')"
            class="w-full px-6 py-4 bg-gray-50 border-b border-gray-200 flex items-center justify-between hover:bg-gray-100 transition-colors"
            data-testid="accordion-labels"
          >
            <div class="text-left">
              <h2 class="text-lg font-semibold text-gray-900">Label History</h2>
              <p class="text-sm text-gray-500 mt-1">{{ labelTotal }} total entries</p>
            </div>
            <svg
              class="w-5 h-5 text-gray-500 transition-transform"
              [class.rotate-180]="sections['labels']"
              fill="none" stroke="currentColor" viewBox="0 0 24 24"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>

          <div *ngIf="sections['labels']">
            <div *ngIf="labelHistory.length === 0" class="p-6 text-center text-gray-500">
              No label history entries found.
            </div>

            <div *ngIf="labelHistory.length > 0" class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Label</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Changed By</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Changed</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <tr *ngFor="let entry of labelHistory" class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ entry.label }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                        [ngClass]="{
                          'bg-green-100 text-green-800': entry.action === 'created',
                          'bg-red-100 text-red-800': entry.action === 'deleted'
                        }"
                      >{{ formatAction(entry.action) }}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ entry.changed_by || '—' }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ formatDate(entry.changed) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- User Account History Accordion -->
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
          <button
            (click)="toggleSection('userAccounts')"
            class="w-full px-6 py-4 bg-gray-50 border-b border-gray-200 flex items-center justify-between hover:bg-gray-100 transition-colors"
            data-testid="accordion-user-accounts"
          >
            <div class="text-left">
              <h2 class="text-lg font-semibold text-gray-900">User Account History</h2>
              <p class="text-sm text-gray-500 mt-1">{{ userAccountTotal }} total entries</p>
            </div>
            <svg
              class="w-5 h-5 text-gray-500 transition-transform"
              [class.rotate-180]="sections['userAccounts']"
              fill="none" stroke="currentColor" viewBox="0 0 24 24"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>

          <div *ngIf="sections['userAccounts']">
            <div *ngIf="userAccountHistory.length === 0" class="p-6 text-center text-gray-500">
              No user account history entries found.
            </div>

            <div *ngIf="userAccountHistory.length > 0" class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Changed By</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Changed</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <tr *ngFor="let entry of userAccountHistory" class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ entry.user_email }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                        [ngClass]="{
                          'bg-green-100 text-green-800': entry.action === 'created' || entry.action === 'activated' || entry.action === 'role_assigned',
                          'bg-red-100 text-red-800': entry.action === 'deleted' || entry.action === 'deactivated' || entry.action === 'role_removed',
                          'bg-blue-100 text-blue-800': entry.action === 'updated'
                        }"
                      >{{ formatAction(entry.action) }}</span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-600">{{ entry.details || '—' }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ entry.changed_by || '—' }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ formatDate(entry.changed) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Role & Permission History Accordion -->
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
          <button
            (click)="toggleSection('rolePermissions')"
            class="w-full px-6 py-4 bg-gray-50 border-b border-gray-200 flex items-center justify-between hover:bg-gray-100 transition-colors"
            data-testid="accordion-role-permissions"
          >
            <div class="text-left">
              <h2 class="text-lg font-semibold text-gray-900">Role & Permission History</h2>
              <p class="text-sm text-gray-500 mt-1">{{ rolePermissionTotal }} total entries</p>
            </div>
            <svg
              class="w-5 h-5 text-gray-500 transition-transform"
              [class.rotate-180]="sections['rolePermissions']"
              fill="none" stroke="currentColor" viewBox="0 0 24 24"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>

          <div *ngIf="sections['rolePermissions']">
            <div *ngIf="rolePermissionHistory.length === 0" class="p-6 text-center text-gray-500">
              No role permission history entries found.
            </div>

            <div *ngIf="rolePermissionHistory.length > 0" class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Changed By</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Changed</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <tr *ngFor="let entry of rolePermissionHistory" class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ entry.role_name }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                        [ngClass]="{
                          'bg-green-100 text-green-800': entry.action === 'created' || entry.action === 'permissions_updated',
                          'bg-red-100 text-red-800': entry.action === 'deleted',
                          'bg-blue-100 text-blue-800': entry.action === 'updated'
                        }"
                      >{{ formatAction(entry.action) }}</span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-600">{{ entry.details || '—' }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ entry.changed_by || '—' }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ formatDate(entry.changed) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Field Type History Accordion -->
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
          <button
            (click)="toggleSection('fieldTypes')"
            class="w-full px-6 py-4 bg-gray-50 border-b border-gray-200 flex items-center justify-between hover:bg-gray-100 transition-colors"
            data-testid="accordion-field-types"
          >
            <div class="text-left">
              <h2 class="text-lg font-semibold text-gray-900">Field Type History</h2>
              <p class="text-sm text-gray-500 mt-1">{{ fieldTypeTotal }} total entries</p>
            </div>
            <svg
              class="w-5 h-5 text-gray-500 transition-transform"
              [class.rotate-180]="sections['fieldTypes']"
              fill="none" stroke="currentColor" viewBox="0 0 24 24"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>

          <div *ngIf="sections['fieldTypes']">
            <div *ngIf="fieldTypeHistory.length === 0" class="p-6 text-center text-gray-500">
              No field type history entries found.
            </div>

            <div *ngIf="fieldTypeHistory.length > 0" class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Field Name</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Type</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Changed By</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Changed</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <tr *ngFor="let entry of fieldTypeHistory" class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-900">{{ entry.field_name }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">
                      {{ entry.configured_type }}<span *ngIf="entry.datetime_format" class="text-gray-400 ml-1">({{ entry.datetime_format }})</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                        [ngClass]="{
                          'bg-green-100 text-green-800': entry.action === 'created',
                          'bg-red-100 text-red-800': entry.action === 'deleted',
                          'bg-blue-100 text-blue-800': entry.action === 'updated'
                        }"
                      >{{ formatAction(entry.action) }}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ entry.changed_by || '—' }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ formatDate(entry.changed) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- API Key History Accordion -->
        <div class="bg-white border border-gray-200 rounded-lg overflow-hidden">
          <button
            (click)="toggleSection('apiKeys')"
            class="w-full px-6 py-4 bg-gray-50 border-b border-gray-200 flex items-center justify-between hover:bg-gray-100 transition-colors"
            data-testid="accordion-api-keys"
          >
            <div class="text-left">
              <h2 class="text-lg font-semibold text-gray-900">API Key History</h2>
              <p class="text-sm text-gray-500 mt-1">{{ apiKeyTotal }} total entries</p>
            </div>
            <svg
              class="w-5 h-5 text-gray-500 transition-transform"
              [class.rotate-180]="sections['apiKeys']"
              fill="none" stroke="currentColor" viewBox="0 0 24 24"
            >
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
            </svg>
          </button>

          <div *ngIf="sections['apiKeys']">
            <div *ngIf="apiKeyHistory.length === 0" class="p-6 text-center text-gray-500">
              No API key history entries found.
            </div>

            <div *ngIf="apiKeyHistory.length > 0" class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                  <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Label</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Key GID</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Changed By</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Changed</th>
                  </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                  <tr *ngFor="let entry of apiKeyHistory" class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ entry.label }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-500">{{ entry.api_key_gid }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                      <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                        [ngClass]="{
                          'bg-green-100 text-green-800': entry.action === 'created',
                          'bg-red-100 text-red-800': entry.action === 'revoked'
                        }"
                      >{{ formatAction(entry.action) }}</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ entry.changed_by || '—' }}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ formatDate(entry.changed) }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>
