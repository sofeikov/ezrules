<div class="flex min-h-screen bg-gray-50">
  <!-- Sidebar -->
  <app-sidebar></app-sidebar>

  <!-- Main Content -->
  <div class="ml-64 flex-1">
    <div class="p-8">
      <!-- Header -->
      <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Shadow Rules</h1>
        <p class="text-gray-600 mt-1">Rules running in observe-only mode on live traffic</p>
      </div>

      <!-- Action Success -->
      <div *ngIf="actionSuccess" class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
        <div class="flex items-center">
          <svg class="w-5 h-5 text-green-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <p class="text-sm font-medium text-green-800">{{ actionSuccess }}</p>
        </div>
      </div>

      <!-- Action Error -->
      <div *ngIf="actionError" class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
        <div class="flex items-center">
          <svg class="w-5 h-5 text-red-600 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <p class="text-sm font-medium text-red-800">{{ actionError }}</p>
        </div>
      </div>

      <!-- Loading State -->
      <div *ngIf="loading" class="flex justify-center items-center py-20">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-amber-500"></div>
      </div>

      <!-- Error State -->
      <div *ngIf="error && !loading" class="bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
        <p class="text-sm font-medium text-red-800">{{ error }}</p>
      </div>

      <!-- Content -->
      <div *ngIf="!loading && !error">

        <!-- Empty State -->
        <div *ngIf="shadowConfig.rules.length === 0" class="text-center py-20" data-testid="empty-state">
          <svg class="mx-auto h-16 w-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          <h3 class="mt-4 text-lg font-medium text-gray-900">No rules in shadow</h3>
          <p class="mt-2 text-sm text-gray-500">Deploy a rule to shadow from the rule detail page to start live observation.</p>
          <a routerLink="/rules" class="mt-6 inline-flex items-center px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600">
            Go to Rules
          </a>
        </div>

        <!-- Shadow Rule Cards -->
        <div *ngIf="shadowConfig.rules.length > 0">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-900">Rules in Shadow</h2>
            <span class="text-sm text-gray-400">Config version {{ shadowConfig.version }}</span>
          </div>

          <div class="space-y-4" data-testid="shadow-rules-table">
            <div *ngFor="let item of getRuleStats()" class="bg-white border border-gray-200 rounded-lg overflow-hidden">

              <!-- Card Header: identity + actions -->
              <div class="px-6 py-4 flex items-start justify-between gap-4 border-b border-gray-100">
                <div class="min-w-0">
                  <div class="flex items-center gap-2 mb-1">
                    <span class="font-mono text-sm font-semibold text-gray-900">{{ item.rule.rid }}</span>
                    <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium bg-amber-100 text-amber-800">SHADOW</span>
                    <span class="text-xs text-gray-400">{{ item.stats?.total ?? 0 }} events evaluated</span>
                  </div>
                  <p class="text-sm text-gray-500 truncate">{{ item.rule.description }}</p>
                </div>
                <div class="flex items-center gap-3 shrink-0">
                  <button
                    (click)="editShadowRule(item.rule)"
                    class="px-3 py-1.5 text-sm text-blue-600 border border-blue-200 rounded-lg hover:bg-blue-50 transition-colors"
                  >
                    Edit
                  </button>
                  <button
                    (click)="openPromoteDialog(item.rule)"
                    class="px-3 py-1.5 text-sm text-green-600 border border-green-200 rounded-lg hover:bg-green-50 transition-colors"
                    data-testid="promote-button"
                  >
                    Promote
                  </button>
                  <button
                    (click)="removeFromShadow(item.rule)"
                    class="px-3 py-1.5 text-sm text-red-600 border border-red-200 rounded-lg hover:bg-red-50 transition-colors"
                    data-testid="remove-shadow-button"
                  >
                    Remove
                  </button>
                </div>
              </div>

              <!-- Logic preview -->
              <div class="px-6 py-3 bg-gray-50 border-b border-gray-100">
                <code class="text-xs font-mono text-gray-500">{{ item.rule.logic | slice:0:120 }}{{ item.rule.logic.length > 120 ? '…' : '' }}</code>
              </div>

              <!-- Outcome comparison -->
              <div class="px-6 py-4">
                <p *ngIf="!item.stats || item.stats.total === 0" class="text-sm text-gray-400 italic">No shadow evaluations yet.</p>

                <div *ngIf="item.stats && item.stats.total > 0" class="grid grid-cols-2 gap-8">
                  <!-- Production -->
                  <div>
                    <p class="text-xs font-semibold text-gray-400 uppercase tracking-wide mb-3">Production (live)</p>
                    <div class="space-y-2">
                      <div *ngFor="let o of item.stats.prod_outcomes" class="flex items-center gap-2">
                        <span class="text-xs text-gray-600 w-20 truncate">{{ o.outcome }}</span>
                        <div class="flex-1 bg-gray-100 rounded-full h-1.5">
                          <div class="bg-blue-400 h-1.5 rounded-full" [style.width.%]="(o.count / item.stats!.total) * 100"></div>
                        </div>
                        <span class="text-xs text-gray-500 w-14 text-right">{{ o.count }} ({{ (o.count / item.stats!.total * 100) | number:'1.0-0' }}%)</span>
                      </div>
                    </div>
                  </div>

                  <!-- Shadow -->
                  <div>
                    <p class="text-xs font-semibold text-amber-500 uppercase tracking-wide mb-3">Shadow (candidate)</p>
                    <div class="space-y-2">
                      <div *ngFor="let o of item.stats.shadow_outcomes" class="flex items-center gap-2">
                        <span class="text-xs text-gray-600 w-20 truncate">{{ o.outcome }}</span>
                        <div class="flex-1 bg-gray-100 rounded-full h-1.5">
                          <div class="bg-amber-400 h-1.5 rounded-full" [style.width.%]="(o.count / item.stats!.total) * 100"></div>
                        </div>
                        <span class="text-xs text-gray-500 w-14 text-right">{{ o.count }} ({{ (o.count / item.stats!.total * 100) | number:'1.0-0' }}%)</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Promote Confirmation Dialog -->
<div *ngIf="showPromoteDialog" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" data-testid="promote-dialog">
  <div class="bg-white rounded-lg shadow-xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
    <h3 class="text-lg font-semibold text-gray-900 mb-2">Promote to Production</h3>
    <p class="text-sm text-gray-600 mb-4">
      Are you sure you want to promote <strong>{{ promoteTarget?.rid }}</strong> to production?
      This will replace the current production version of this rule.
    </p>

    <!-- Diff Section -->
    <div class="mb-6">
      <h4 class="text-sm font-medium text-gray-700 mb-2">Logic changes (production → shadow):</h4>

      <!-- Loading production rule -->
      <div *ngIf="loadingProductionRule" class="flex items-center gap-2 text-sm text-gray-500 py-4">
        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-gray-400"></div>
        Loading production logic...
      </div>

      <!-- No production rule found (new rule in shadow) -->
      <div *ngIf="!loadingProductionRule && !productionRule" class="bg-gray-50 border border-gray-200 rounded p-3">
        <p class="text-xs text-gray-500 mb-2">Could not load production rule — showing shadow logic:</p>
        <pre class="text-xs font-mono text-gray-700 whitespace-pre-wrap">{{ promoteTarget?.logic }}</pre>
      </div>

      <!-- Diff when both loaded -->
      <div *ngIf="!loadingProductionRule && productionRule">
        <!-- No diff: identical logic -->
        <div *ngIf="computePromoteDiff().length === 1 && !computePromoteDiff()[0].added && !computePromoteDiff()[0].removed"
             class="bg-gray-50 border border-gray-200 rounded p-3">
          <p class="text-xs text-gray-500">Logic is identical to current production version.</p>
        </div>

        <!-- Diff lines -->
        <div *ngIf="computePromoteDiff().length > 1 || computePromoteDiff()[0]?.added || computePromoteDiff()[0]?.removed"
             class="border border-gray-200 rounded overflow-hidden font-mono text-xs">
          <div class="bg-gray-100 px-3 py-1.5 border-b border-gray-200 flex gap-4 text-gray-600">
            <span class="flex items-center gap-1"><span class="inline-block w-3 h-3 bg-red-200 border border-red-400 rounded-sm"></span> production</span>
            <span class="flex items-center gap-1"><span class="inline-block w-3 h-3 bg-green-200 border border-green-400 rounded-sm"></span> shadow (incoming)</span>
          </div>
          <div class="max-h-64 overflow-y-auto">
            <div *ngFor="let chunk of computePromoteDiff()"
                 [class]="chunk.added ? 'bg-green-50 text-green-900' : chunk.removed ? 'bg-red-50 text-red-900' : 'bg-white text-gray-700'"
                 class="px-3 py-0.5 whitespace-pre-wrap leading-5">
              <span class="select-none mr-1 opacity-60">{{ chunk.added ? '+' : chunk.removed ? '-' : ' ' }}</span>{{ chunk.value }}</div>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="promoteError" class="bg-red-50 border border-red-200 rounded p-3 mb-4">
      <p class="text-sm text-red-800">{{ promoteError }}</p>
    </div>

    <div class="flex gap-3 justify-end">
      <button
        (click)="closePromoteDialog()"
        [disabled]="promoting"
        class="px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 disabled:cursor-not-allowed"
        data-testid="cancel-promote-button"
      >
        Cancel
      </button>
      <button
        (click)="confirmPromote()"
        [disabled]="promoting"
        class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
        data-testid="confirm-promote-button"
      >
        <span *ngIf="!promoting">Yes, Promote</span>
        <span *ngIf="promoting">Promoting...</span>
      </button>
    </div>
  </div>
</div>
